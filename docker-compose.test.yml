# docker-compose.test.yml
# Test-specific Docker Compose for running VerifyWise during integration and E2E tests.
# Uses pre-built images with hardcoded test credentials.
# Usage: docker compose -f docker-compose.test.yml up -d

services:
  postgresdb:
    image: postgres:16.8
    environment:
      POSTGRES_USER: verifywise_test
      POSTGRES_PASSWORD: verifywise_test
      POSTGRES_DB: verifywise_test
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "verifywise_test", "-d", "verifywise_test"]
      interval: 5s
      timeout: 5s
      retries: 10

  redis:
    image: redis:7
    expose:
      - "6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  backend:
    depends_on:
      postgresdb:
        condition: service_healthy
      redis:
        condition: service_healthy
    image: ghcr.io/bluewave-labs/verifywise-backend:latest
    pull_policy: always
    ports:
      - "3000:3000"
    environment:
      PORT: "3000"
      DB_HOST: postgresdb
      DB_PORT: "5432"
      DB_USER: verifywise_test
      DB_PASSWORD: verifywise_test
      DB_NAME: verifywise_test
      NODE_ENV: test
      MOCK_DATA_ON: "true"
      JWT_SECRET: test-jwt-secret-for-integration-testing-only-not-for-production
      REFRESH_TOKEN_SECRET: test-refresh-secret-for-integration-testing-only-not-for-production
      ENCRYPTION_KEY: test-encryption-key-32-characters!
      LLM_EVALS_URL: http://eval_server:8000
      REDIS_URL: redis://redis:6379/0
      EMAIL_PROVIDER: smtp
      SMTP_HOST: "localhost"
      SMTP_PORT: "1025"
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:3000/api/users/check-user-exists || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 30s

  worker:
    depends_on:
      postgresdb:
        condition: service_healthy
      redis:
        condition: service_healthy
    image: ghcr.io/bluewave-labs/verifywise-backend:latest
    pull_policy: always
    command: ["node", "dist/jobs/worker.js"]
    environment:
      DB_HOST: postgresdb
      DB_PORT: "5432"
      DB_USER: verifywise_test
      DB_PASSWORD: verifywise_test
      DB_NAME: verifywise_test
      JWT_SECRET: test-jwt-secret-for-integration-testing-only-not-for-production
      REFRESH_TOKEN_SECRET: test-refresh-secret-for-integration-testing-only-not-for-production
      ENCRYPTION_KEY: test-encryption-key-32-characters!
      REDIS_URL: redis://redis:6379/0
    restart: unless-stopped

  eval_server:
    depends_on:
      - backend
      - redis
    image: ghcr.io/bluewave-labs/verifywise-eval-server:latest
    pull_policy: always
    expose:
      - "8000"
    environment:
      DB_HOST: postgresdb
      DB_PORT: "5432"
      DB_USER: verifywise_test
      DB_PASSWORD: verifywise_test
      DB_NAME: verifywise_test
      BACKEND_URL: http://backend:3000
      REDIS_URL: redis://redis:6379/0

  frontend:
    depends_on:
      - backend
    image: ghcr.io/bluewave-labs/verifywise-frontend:latest
    pull_policy: always
    ports:
      - "8080:80"

volumes:
  db_test:
  eval_uploads_test:
